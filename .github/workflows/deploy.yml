# Workflow CD - Deploiement automatique sur VPS
# Declench sur push vers main (aprs merge de dev)
#
# Secrets GitHub requis :
#   VPS_HOST      - IP ou hostname du VPS
#   VPS_USER      - Utilisateur SSH
#   VPS_SSH_KEY   - Cle privee SSH (ed25519 ou rsa)
#   VPS_PROJECT_PATH - Chemin du projet sur le VPS (ex: /opt/innovevents)

name: CD - Deploy

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/**'

# Empecher les deploiements simultans
concurrency:
  group: production
  cancel-in-progress: false

jobs:
  # S'assurer que les tests passent avant de deployer
  test:
    name: Run Tests
    uses: ./.github/workflows/ci.yml

  # Deploiement sur le VPS via SSH
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ${{ secrets.VPS_PROJECT_PATH }}

            echo "--- Pull des derniers changements ---"
            git pull origin main

            echo "--- Build et redemarrage des containers ---"
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d

            echo "--- Initialisation / mise a jour des tables ---"
            sleep 5
            for f in docs/database/0*.sql; do
              docker compose -f docker-compose.prod.yml exec -T db psql -U postgres -d innovevents < "$f"
            done

            echo "--- Nettoyage des anciennes images ---"
            docker image prune -f

            echo "--- Verification du healthcheck ---"
            sleep 10
            curl -sf https://inno.st4m.fr/health || echo "Healthcheck failed (non bloquant)"

            echo "--- Deploiement termine ---"
